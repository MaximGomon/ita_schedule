<<<<<<< HEAD
﻿
using System;
using System.Collections.Generic;
using System.Linq;
using System.Web;
using System.Web.Mvc;
=======
﻿using System.Web.Mvc;
>>>>>>> 76da8a9b739b4abae44347c1b33c29669c4434e9
using ITA.Schedule.Models;
using ITA.Schedule.BLL.Implementations;
using ITA.Schedule.DAL.Repositories.Implementations;
using ITA.Schedule.Entity.Entities;

<<<<<<< HEAD
using System.Net.Mail;
using ITA.Schedule.BLL;
=======
>>>>>>> 76da8a9b739b4abae44347c1b33c29669c4434e9
using ITA.Schedule.Logs.Filters;


namespace ITA.Schedule.Controllers
{
    public class HomeController : Controller
    {
        //ScheduleUnitOfWork _unitOfWork = new ScheduleUnitOfWork();
        // GET: Authorization
        [ActionLog]
        public ActionResult Authorization()
        {
<<<<<<< HEAD
            ViewBag.AlertLogin = TempData["AlertLogin"];
            ViewBag.AlertRegister = TempData["AlertRegister"];
            TempData["AlertLogin"] = null;
            TempData["AlertRegister"] = null;

            //var teacher = new Teacher();
            //Guid teacherId = _unitOfWork.Teacher.Insert(teacher);
            //var entity = new User {Teacher = teacher};
            //Guid userId = _unitOfWork.User.Insert(entity);
=======
>>>>>>> 76da8a9b739b4abae44347c1b33c29669c4434e9
            return View();
        }

        [ActionLog]
        [HttpPost]
        public ActionResult Login(UserViewModel userModel)
        {
            User user;
            return  !ModelState.IsValidField("Email") && !ModelState.IsValidField("Password") ? 
                        SetAlertsMessege(userModel, new AlertsMessege().LoginFormNotValid())  : 
                    TryToAuthorizeUser(out user, userModel) ? SetAlertsMessege(userModel, new AlertsMessege().LoginNoMatchesInDb()) :
                    user.SecurityGroup.Name == "Admin"   ? RedirectToAction( "Index", "Admin",   new { area = "Admin" })   :
                    user.SecurityGroup.Name == "Student" ? RedirectToAction( "Index", "Student", new { area = "Student" }) :
                    user.SecurityGroup.Name == "Teacher" ? RedirectToAction( "Index", "Teacher", new { area = "Teacher" }) :
                    SetAlertsMessege(userModel, new AlertsMessege().LoginSomethingWentWrong());
        }

        [ActionLog]
        [HttpPost]
        public ActionResult Register(UserViewModel userModel)
        {
            User user;
            return  !ModelState.IsValidField("Email") && !ModelState.IsValidField("Password") &&
                    !ModelState.IsValidField("FirstName") && !ModelState.IsValidField("LastName") && !ModelState.IsValidField("Role") ?
                        SetAlertsMessege(userModel, new AlertsMessege().RegisterFormNotValid()) :
                    GetUserByLogin(out user, userModel) ? SetAlertsMessege(userModel, new AlertsMessege().RegisterEmailAlreadyExist()) :

                    SetAlertsMessege(userModel, new AlertsMessege
                    {
                        Status = AlertsMessege.StatusesEnum.Info,
                        Tittle = "I don't know what to do further!",
                        Text   = "Do someone something!"
                    })

                    ;
        }

        public bool TryToAuthorizeUser(out User user, UserViewModel userModel)
        {
            user = new UserBl(new UserRepository()).AuthorizeApp(userModel.Email, userModel.Password);
            return user == null;
        }

        public bool GetUserByLogin(out User user, UserViewModel userModel)
        {
            user = new UserBl(new UserRepository()).GetByLogin(userModel.Email);
            return user != null;
        }

        public ActionResult SetAlertsMessege(UserViewModel userModel, AlertsMessege messege)
        {
            ViewBag.AlertsMessege = messege;
            return View("Authorization", userModel);
        }
    }
}